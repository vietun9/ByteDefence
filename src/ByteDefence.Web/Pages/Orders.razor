@page "/orders"
@attribute [Authorize]
@inject IOrderService OrderService
@inject ISignalRService SignalR
@inject NavigationManager Navigation
@inject OrderState OrderState
@inject ToastService ToastService
@inject ILogger<Orders> Logger
@implements IDisposable

<PageTitle>Orders - ByteDefence</PageTitle>

<div class="orders-page">
    <div class="page-header">
        <h1>ðŸ“¦ Orders</h1>
        <div class="header-actions">
            <ConnectionStatus State="@_connectionState" />
            <button class="btn btn-primary" @onclick="NavigateToCreate">+ New Order</button>
        </div>
    </div>

    @if (_isLoading)
    {
        <div class="loading">
            <div class="spinner-large"></div>
            <p>Loading orders...</p>
        </div>
    }
    else if (_error != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @_error
            <button class="btn btn-sm" @onclick="LoadOrders">Retry</button>
        </div>
    }
    else if (_orders == null || !_orders.Any())
    {
        <div class="empty-state">
            <p>No orders found.</p>
            <button class="btn btn-primary" @onclick="NavigateToCreate">Create your first order</button>
        </div>
    }
    else
    {
        @if (_hasUpdate)
        {
            <div class="alert alert-info update-banner">
                Orders have been updated. <button class="btn btn-link" @onclick="LoadOrders">Refresh</button>
            </div>
        }

        <div class="orders-grid">
            @foreach (var order in _orders)
            {
                <div class="order-card" @onclick="() => NavigateToDetail(order.Id)">
                    <div class="order-header">
                        <h3>@order.Title</h3>
                        <span class="status-badge @GetStatusClass(order.Status)">@order.Status</span>
                    </div>
                    <p class="order-description">@order.Description</p>
                    <div class="order-meta">
                        <span>@order.Items.Count items</span>
                        <span class="order-total">@order.Total.ToString("C")</span>
                    </div>
                    <div class="order-footer">
                        <span class="created-by">By @(order.CreatedBy?.Username ?? "Unknown")</span>
                        <span class="created-at">@order.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .orders-page {
        padding: 1rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .page-header h1 {
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .orders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }

    .order-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .order-header h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-draft { background: #e0e0e0; color: #424242; }
    .status-pending { background: #fff3e0; color: #e65100; }
    .status-approved { background: #e3f2fd; color: #1565c0; }
    .status-completed { background: #e8f5e9; color: #2e7d32; }
    .status-cancelled { background: #ffebee; color: #c62828; }

    .order-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .order-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .order-total {
        font-weight: 600;
        color: #2e7d32;
    }

    .order-footer {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #999;
    }

    .loading {
        text-align: center;
        padding: 3rem;
    }

    .spinner-large {
        width: 3rem;
        height: 3rem;
        border: 4px solid #e0e0e0;
        border-top-color: #5c6bc0;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 8px;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .alert-danger {
        background: #ffebee;
        color: #c62828;
    }

    .alert-info {
        background: #e3f2fd;
        color: #1565c0;
    }

    .update-banner {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: #5c6bc0;
        color: white;
    }

    .btn-primary:hover {
        background: #3f51b5;
    }

    .btn-link {
        background: none;
        color: inherit;
        text-decoration: underline;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private List<OrderDto>? _orders;
    private bool _isLoading = true;
    private string? _error;
    private bool _hasUpdate;
    private HubConnectionState _connectionState = HubConnectionState.Disconnected;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
        OrderState.OnChange += OnOrderStateChanged;
        await SetupSignalR();
    }

    private async Task LoadOrders()
    {
        _isLoading = true;
        _error = null;
        _hasUpdate = false;
        StateHasChanged();

        try
        {
            var response = await OrderService.GetOrdersAsync();
            _orders = response?.Orders ?? new List<OrderDto>();
            // seed local state
            foreach (var o in _orders)
            {
                OrderState.Upsert(o);
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SetupSignalR()
    {
        SignalR.OnStateChanged += HandleStateChanged;
        SignalR.OnOrderCreated += HandleOrderCreated;
        SignalR.OnOrderUpdated += HandleOrderUpdated;
        SignalR.OnOrderDeleted += HandleOrderDeleted;

        try
        {
            await SignalR.StartAsync();
            await SignalR.JoinAllOrdersGroupAsync();
            _connectionState = SignalR.State;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect to SignalR");
            _connectionState = HubConnectionState.Disconnected;
        }
    }

    private void HandleStateChanged(HubConnectionState state)
    {
        _connectionState = state;
        InvokeAsync(StateHasChanged);
    }

    private void HandleOrderCreated(object data)
    {
        try
        {
            if (data is System.Text.Json.JsonElement json)
            {
                var order = System.Text.Json.JsonSerializer.Deserialize<OrderDto>(json.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (order != null)
                {
                    OrderState.Upsert(order);
                    ToastService.ShowInfo($"Order {order.Title} created");
                }
            }
        }
        catch (Exception ex) 
        {
            Logger.LogError(ex, "Error handling OrderCreated");
        }
    }

    private void HandleOrderUpdated(object data)
    {
        try
        {
            if (data is System.Text.Json.JsonElement json)
            {
                var order = System.Text.Json.JsonSerializer.Deserialize<OrderDto>(json.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (order != null)
                {
                    OrderState.Upsert(order);
                    ToastService.ShowInfo($"Order {order.Title} updated");
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling OrderUpdated");
        }
    }

    private void HandleOrderDeleted(string orderId)
    {
        OrderState.Remove(orderId);
        ToastService.ShowInfo($"Order {orderId} deleted");
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/orders/new");
    }

    private void NavigateToDetail(string orderId)
    {
        Navigation.NavigateTo($"/orders/{orderId}");
    }

    private string GetStatusClass(string status) => status.ToLower() switch
    {
        "draft" => "status-draft",
        "pending" => "status-pending",
        "approved" => "status-approved",
        "completed" => "status-completed",
        "cancelled" => "status-cancelled",
        _ => ""
    };

    public void Dispose()
    {
        SignalR.LeaveAllOrdersGroupAsync().ConfigureAwait(false);
        SignalR.OnStateChanged -= HandleStateChanged;
        SignalR.OnOrderCreated -= HandleOrderCreated;
        SignalR.OnOrderUpdated -= HandleOrderUpdated;
        SignalR.OnOrderDeleted -= HandleOrderDeleted;
        OrderState.OnChange -= OnOrderStateChanged;
    }

    private void OnOrderStateChanged()
    {
        _orders = OrderState.GetAll().ToList();
        InvokeAsync(StateHasChanged);
    }
}
