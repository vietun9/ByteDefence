@page "/orders/new"
@attribute [Authorize]
@inject IOrderService OrderService
@inject NavigationManager Navigation

<PageTitle>Create Order - ByteDefence</PageTitle>

<div class="create-order-page">
    <div class="page-header">
        <button class="btn btn-back" @onclick="GoBack">‚Üê Back to Orders</button>
        <h1>Create New Order</h1>
    </div>

    @if (_error != null)
    {
        <div class="alert alert-danger">@_error</div>
    }

    <div class="form-card">
        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label for="title">Title *</label>
                <InputText id="title" class="form-control" @bind-Value="_model.Title" placeholder="Enter order title" />
                <ValidationMessage For="@(() => _model.Title)" />
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <InputTextArea id="description" class="form-control" @bind-Value="_model.Description" 
                    placeholder="Enter order description" rows="4" />
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" @onclick="GoBack">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                    @if (_isSubmitting)
                    {
                        <span class="spinner"></span> <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Order</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

<style>
    .create-order-page {
        padding: 1rem;
        max-width: 600px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 1.5rem;
    }

    .page-header h1 {
        margin: 1rem 0 0 0;
    }

    .btn-back {
        background: transparent;
        border: none;
        color: #5c6bc0;
        cursor: pointer;
        font-size: 1rem;
    }

    .form-card {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #5c6bc0;
    }

    textarea.form-control {
        resize: vertical;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-primary {
        background: #5c6bc0;
        color: white;
    }

    .btn-primary:hover {
        background: #3f51b5;
    }

    .btn-primary:disabled {
        background: #9fa8da;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #e0e0e0;
        color: #333;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .alert-danger {
        background: #ffebee;
        color: #c62828;
    }

    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private CreateOrderModel _model = new();
    private bool _isSubmitting;
    private string? _error;

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _error = null;

        try
        {
            var response = await OrderService.CreateOrderAsync(_model.Title, _model.Description);
            
            if (response?.CreateOrder?.Order != null)
            {
                Navigation.NavigateTo($"/orders/{response.CreateOrder.Order.Id}");
            }
            else
            {
                _error = response?.CreateOrder?.ErrorMessage ?? "Failed to create order";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/orders");
    }

    private class CreateOrderModel
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}
